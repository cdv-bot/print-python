<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Print Client</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }

        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .controls {
            margin: 20px 0;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 20px;
        }

        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }

        .log-entry.info {
            color: #0c5460;
        }

        .log-entry.success {
            color: #155724;
        }

        .log-entry.error {
            color: #721c24;
        }

        .log-entry.warning {
            color: #856404;
        }

        .printer-list {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }

        .printer-item {
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-radius: 3px;
            border-left: 4px solid #007bff;
        }

        select {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        textarea {
            width: 100%;
            height: 100px;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üñ®Ô∏è WebSocket Print Client</h1>

        <div id="status" class="status disconnected">
            ‚ùå Ch∆∞a k·∫øt n·ªëi
        </div>

        <div class="controls">
            <button id="connectBtn" onclick="connect()">üîå K·∫øt n·ªëi WebSocket</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled>‚ùå Ng·∫Øt k·∫øt n·ªëi</button>
            <button id="listPrintersBtn" onclick="requestPrinterList()" disabled>üìã L·∫•y danh s√°ch m√°y in</button>
            <button id="clearLogBtn" onclick="clearLog()">üóëÔ∏è X√≥a log</button>
        </div>

        <div class="controls">
            <h3>üìÑ Test Print</h3>
            <select id="printerSelect">
                <option value="">Ch·ªçn m√°y in...</option>
            </select>
            <textarea id="printContent" placeholder="Nh·∫≠p n·ªôi dung c·∫ßn in...">ƒê√¢y l√† test print t·ª´ HTML WebSocket Client.

N·ªôi dung n√†y ƒë∆∞·ª£c g·ª≠i t·ª´ tr√¨nh duy·ªát web t·ªõi Python WebSocket Print Client.

N·∫øu b·∫°n th·∫•y trang n√†y, ch·ª©c nƒÉng in ƒë√£ ho·∫°t ƒë·ªông th√†nh c√¥ng!

Th·ªùi gian: {{timestamp}}</textarea>
            <button id="printBtn" onclick="sendPrintTest()" disabled>üñ®Ô∏è In th·ª≠ nghi·ªám</button>
            <button id="printCustomBtn" onclick="sendCustomPrint()" disabled>üìù In n·ªôi dung t√πy ch·ªânh</button>
        </div>

        <div id="printerList" class="printer-list" style="display: none;">
            <h3>üìã Danh s√°ch m√°y in:</h3>
            <div id="printers"></div>
        </div>

        <div class="log">
            <div id="log"></div>
        </div>
    </div>

    <script>
        let ws = null;
        let clientId = null;
        let printers = [];
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        // Node.js Bridge Server configuration
        const wsUrl = 'ws://localhost:3001'; // Node.js Bridge Server     
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(message, connected = false) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${connected ? 'connected' : 'disconnected'}`;
        }

        function updateButtons(connected = false) {
            document.getElementById('connectBtn').disabled = connected;
            document.getElementById('disconnectBtn').disabled = !connected;
            document.getElementById('listPrintersBtn').disabled = !connected;
            document.getElementById('printBtn').disabled = !connected;
            document.getElementById('printCustomBtn').disabled = !connected;
        }

        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                log('ƒê√£ k·∫øt n·ªëi r·ªìi!', 'warning');
                return;
            }

            log('ƒêang k·∫øt n·ªëi t·ªõi ' + wsUrl + '...', 'info');
            updateStatus('üîÑ ƒêang k·∫øt n·ªëi...', false);

            ws = new WebSocket(wsUrl);

            ws.onopen = function (event) {
                log('‚úÖ ƒê√£ k·∫øt n·ªëi Node.js Bridge Server', 'success');
                updateStatus('‚úÖ ƒê√£ k·∫øt n·ªëi', true);
                updateButtons(true);
                reconnectAttempts = 0;

                // T·ª± ƒë·ªông t·∫£i danh s√°ch m√°y in
                requestPrinterList();
            };

            ws.onmessage = function (event) {
                try {
                    const data = JSON.parse(event.data);
                    handleMessage(data);
                } catch (e) {
                    log('‚ùå L·ªói parse JSON: ' + e.message, 'error');
                }
            };

            ws.onclose = function (event) {
                log('‚ùå WebSocket ƒë√£ ƒë√≥ng. Code: ' + event.code, 'warning');
                updateStatus('‚ùå ƒê√£ ng·∫Øt k·∫øt n·ªëi', false);
                updateButtons(false);
                ws = null;
                clientId = null;

                // Th·ª≠ k·∫øt n·ªëi l·∫°i
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    log(`üîÑ Th·ª≠ k·∫øt n·ªëi l·∫°i (${reconnectAttempts}/${maxReconnectAttempts})...`, 'info');
                    setTimeout(connect, 3000);
                } else {
                    log('‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi l·∫°i WebSocket', 'error');
                }
            };

            ws.onerror = function (error) {
                log('‚ùå L·ªói WebSocket: ' + error, 'error');
                updateStatus('‚ùå L·ªói k·∫øt n·ªëi', false);
                updateButtons(false);
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                log('üîå ƒê√£ ng·∫Øt k·∫øt n·ªëi', 'info');
            }
        }

        function handleMessage(data) {
            log('üì® Nh·∫≠n tin nh·∫Øn: ' + data.type, 'info');

            switch (data.type) {
                case 'welcome':
                    clientId = data.clientId;
                    log('üéâ ' + data.message + ' (ID: ' + clientId + ')', 'success');
                    break;

                case 'printers':
                    if (Array.isArray(data.data)) {
                        log('üìã Nh·∫≠n danh s√°ch m√°y in: ' + data.data.length + ' m√°y in', 'success');
                        displayPrinters(data.data);
                        printers = data.data;
                        updatePrinterSelect();
                    } else {
                        log('‚ùå D·ªØ li·ªáu m√°y in kh√¥ng h·ª£p l·ªá: ' + JSON.stringify(data.data), 'error');
                        printers = [];
                        displayPrinters([]);
                        updatePrinterSelect();
                    }
                    break;

                case 'printResult':
                    if (data.data.status === 'success') {
                        log('‚úÖ ' + data.data.message, 'success');
                    } else {
                        log('‚ùå ' + data.data.message, 'error');
                    }
                    break;

                case 'error':
                    log('‚ùå L·ªói t·ª´ server: ' + (data.message || 'Unknown error'), 'error');
                    break;

                default:
                    log('‚ùì Message type kh√¥ng x√°c ƒë·ªãnh: ' + data.type, 'warning');
                    console.log('Full message:', data);
            }
        }



        function displayPrinters(printerList) {
            const printersDiv = document.getElementById('printers');
            const printerListDiv = document.getElementById('printerList');

            printersDiv.innerHTML = '';

            if (!Array.isArray(printerList)) {
                log('‚ùå printerList kh√¥ng ph·∫£i l√† m·∫£ng: ' + typeof printerList, 'error');
                printerList = [];
            }

            if (printerList.length === 0) {
                printersDiv.innerHTML = '<div class="printer-item">Kh√¥ng c√≥ m√°y in n√†o ƒë∆∞·ª£c t√¨m th·∫•y</div>';
            } else {
                printerList.forEach((printer, index) => {
                    const printerDiv = document.createElement('div');
                    printerDiv.className = 'printer-item';
                    printerDiv.innerHTML = `
                        <strong>${printer.name}</strong><br>
                        <small>Server: ${printer.server || 'Local'} | Status: ${printer.status}</small>
                    `;
                    printersDiv.appendChild(printerDiv);
                });
            }

            printerListDiv.style.display = 'block';
        }

        function updatePrinterSelect() {
            const select = document.getElementById('printerSelect');
            select.innerHTML = '<option value="">Ch·ªçn m√°y in...</option>';

            printers.forEach(printer => {
                const option = document.createElement('option');
                option.value = printer.name;
                option.textContent = `${printer.name} (${printer.status})`;
                select.appendChild(option);
            });
        }

        function requestPrinterList() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('‚ùå Ch∆∞a k·∫øt n·ªëi WebSocket', 'error');
                return;
            }

            log('üìã ƒêang l·∫•y danh s√°ch m√°y in...', 'info');

            const message = {
                type: 'getPrinters'
            };

            ws.send(JSON.stringify(message));
        }

        function sendPrintTest() {
            const selectedPrinter = document.getElementById('printerSelect').value;

            if (!selectedPrinter) {
                log('‚ùå Vui l√≤ng ch·ªçn m√°y in', 'error');
                return;
            }

            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('‚ùå Ch∆∞a k·∫øt n·ªëi WebSocket', 'error');
                return;
            }

            log('üñ®Ô∏è ƒêang g·ª≠i l·ªánh in th·ª≠ nghi·ªám t·ªõi: ' + selectedPrinter, 'info');

            const message = {
                type: 'printTest',
                printer: selectedPrinter
            };

            ws.send(JSON.stringify(message));
        }

        function sendCustomPrint() {
            const selectedPrinter = document.getElementById('printerSelect').value;
            const content = document.getElementById('printContent').value;

            if (!selectedPrinter) {
                log('‚ùå Vui l√≤ng ch·ªçn m√°y in', 'error');
                return;
            }

            if (!content.trim()) {
                log('‚ùå Vui l√≤ng nh·∫≠p n·ªôi dung c·∫ßn in', 'error');
                return;
            }

            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('‚ùå Ch∆∞a k·∫øt n·ªëi WebSocket', 'error');
                return;
            }

            // Thay th·∫ø timestamp trong content
            const finalContent = content.replace('{{timestamp}}', new Date().toLocaleString());

            const message = {
                type: 'print',
                printer: selectedPrinter,
                content: finalContent
            };

            ws.send(JSON.stringify(message));
            log('üìù ƒê√£ g·ª≠i l·ªánh in n·ªôi dung t√πy ch·ªânh t·ªõi: ' + selectedPrinter, 'info');
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('üóëÔ∏è ƒê√£ x√≥a log', 'info');
        }

        // Auto connect on page load
        window.onload = function () {
            log('üöÄ Trang web ƒë√£ t·∫£i xong. S·∫µn s√†ng k·∫øt n·ªëi!', 'info');
        };
    </script>
</body>

</html>